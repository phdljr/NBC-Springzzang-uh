<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>It's me</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
        crossorigin="anonymous"></script>
    <style>
        *{margin: 0; padding: 0;}
        header{min-width: 300px; height: 80px; background-color: rgb(32, 160, 47);
        font-size: 30px; color: white; position: relative;}
        header p{position: absolute; top: 50%; left: 50%;
        transform: translateX(-50%) translateY(-50%);}
        #dm_ul{position: relative;  margin: auto; background-color: none; text-align: right; }
          .dropmenu ul ul{position: absolute; display: none;  }
          .dropmenu ul ul li{display: block; background-color: white; color: white;}
        .dropmenu ul li{display: inline-block; margin-left: -5.5px;}
        .dropmenu ul li a{display: block; width: 100px; color: black; line-height: 43px;
          text-decoration: none; text-align: center;}
        #test{display: block; width: 100px; color: black; line-height: 43px;
            text-decoration: none; text-align: right;}

        
        .btn-btn-primary {
            background-color: white;
            color: #000;
            border: none;
            border-radius: 5px;
            padding: 10px 20px;
            cursor: pointer;
            margin-left: 90%;
            font-size: 16px;
            transition: background-color 0.3s;
        }

        .btn-btn-primary:hover {
            background-color: rgb(0, 166, 255);
        }

        .modal-title {
            color: #000000;

        }

        .col-form-label {
            color: #000000;
        }

        .button {
            background-color: rgba(71, 129, 255, 0.445);
            width: 100px;
            height: 50px;
            border-radius: 10px;
            display: flex;
            margin-left: 95%;
            text-align: center;
            justify-content: center;

        }

        body {
            font-family: Arial, sans-serif;
            background-color: #222;
            color: #fff;
            text-align: center;
            padding: 20px;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            vertical-align: middle;
        }

        h1 {
            font-size: 30px;
        }

        .team-member {
            border: 2px solid #00ff00;
            border-radius: 10px;
            padding: 10px;
            margin: 20px;
            max-width: 300px;
            width: 100%;
            background-color: #333;
        }

        .team-member img {
            max-width: 100%;
            border-radius: 50%;
        }

        .team-member h3 {
            margin-top: 10px;
        }

        .team-members {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            justify-content: center;
        }

        .container {
            width: 1200px;
            margin: 0px auto;
        }
    </style>

    <script type="module">
        import { collection, addDoc, doc } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
        import { getDocs, updateDoc, deleteDoc, setDoc } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
        import { db, storage } from "./js/db.js";
        import { ref, getDownloadURL, uploadBytes, deleteObject } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-storage.js"

        $("#btn").click(async function () {
            const position = $('#position').val();
            const name = $('#name').val();
            const imageUrl = $('#imageUrl').val();
            const info_mbti = $('#info_mbti').val();
            const advantage = $('#advantage').val();
            const codingStyle = $('#codingStyle').val();
            const teamFeature_Goal = $('#teamFeature_Goal').val();
            const teamPromise = $('#teamPromise').val();
            const blogUrl = $('#blogUrl').val();
            const file = document.querySelector('#imageUrl').files[0];

            const data = {
                position: position,
                name: name,
                imageUrl: file.name,
                info_mbti: info_mbti,
                advantage: advantage,
                codingStyle: codingStyle,
                teamFeature_Goal: teamFeature_Goal,
                teamPromise: teamPromise,
                blogUrl: blogUrl
            };

            await addDoc(collection(db, "members"), data);

            const storageRef = ref(storage, file.name);

            uploadBytes(storageRef, file).then((snapshot) => {
                alert('저장 완료!');
                window.location.reload();
            });
        });

        let docs = await getDocs(collection(db, "members"));

        docs.forEach((document) => {
            let row = document.data();
            console.log(row);

            const id = document.id;
            const imageUrl = row["imageUrl"];
            const position = row["position"];
            const name = row["name"];
            const dropdown=row["name"];

            getDownloadURL(ref(storage, imageUrl))
                .then((url) => {
                    let html = `
                        <div class="team-member">
                            <div  class="dropmenu">
                                <ul id="dm_ul">
                                  <li id=${dropdown} >
                                    <a id="test" href="#">
                                    <svg xmlns="http://www.w3.org/2000/svg" color="white" overflow:"hidden" width="40" height="40" fill="currentColor" class="bi bi-three-dots" viewBox="0 0 16 16">
                                        <path d="M3 9.5a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3zm5 0a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3zm5 0a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3z"/>
                                      </svg>
                                  </a>
                                    <ul >
                                      <li><a href="#" id=${id} >삭제</a></li>
                                      <li><a href="edit.html?id=${id}">수정</a></li>
                                    </ul>
                                  </li>
                                  </ul>
                              </div>
                            <a href="intro.html?id=${id}">
                                <img src=${url} alt=${position} style="width: 230px; height: 300px;">
                            </a>
                            <h3>${name}</h3>
                            <p>${position}</p>
                        </div>
                    `;

                    $('#wrapper').append(html);

                    
                    $(`#${dropdown}`).click(function(e){
                        $(this).find("ul").stop().fadeToggle(300); 
                    });
			
                    $(`#${id}`).click(async function () {
                        if (confirm("삭제하시겠습니까?")) {
                            // 데이터 삭제
                            await deleteDoc(doc(db, "members", id));
                            // 사진 삭제
                            deleteObject(ref(storage, imageUrl)).then(() => {
                                alert("삭제 완료");
                                window.location.reload();
                            }).catch((error) => {
                                alert("삭제에 실패했습니다.");
                            });
                        }
                    });
                });
        });
    </script>
</head>

<body>
    <button type="button" id="button" class="btn-btn-primary" data-bs-toggle="modal" data-bs-target="#exampleModal"
        data-bs-whatever="@mdo">멤버 추가
    </button>
    <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h1 class="modal-title" id="exampleModalLabel">팀원 신청서</h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form>
                        <div class="mb-3">
                            <label for="recipient-name" class="col-form-label">이름</label>
                            <input type="text" class="form-control" id="name">
                        </div>
                        <div class="mb-3">
                            <label for="recipient-name" class="col-form-label">역할</label>
                            <input type="text" class="form-control" id="position">
                        </div>
                        <div class="mb-3">
                            <label for="recipient-name" class="col-form-label">사진 파일</label>
                            <input type="file" class="form-control" id="imageUrl">
                        </div>
                        <div class="mb-3">
                            <label for="recipient-name" class="col-form-label">[팀]과 [자신]에 대한 설명 및 MBTI</label>
                            <input type="text" class="form-control" id="info_mbti">
                        </div>
                        <div class="mb-3">
                            <label for="message-text" class="col-form-label">객관적으로 살펴본 자신의 장점</label>
                            <textarea class="form-control" id="advantage"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="message-text" class="col-form-label">자신의 스타일 협업 스타일 소개</label>
                            <textarea class="form-control" id="codingStyle"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="message-text" class="col-form-label">우리 팀만의 특징과 추구하는 궁극적인 목표</label>
                            <textarea class="form-control" id="teamFeature_Goal"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="message-text" class="col-form-label">우리 팀의 약속</label>
                            <textarea class="form-control" id="teamPromise"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="message-text" class="col-form-label">팀원들의 블로그 주소</label>
                            <input type="text" class="form-control" id="blogUrl">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
                    <button id="btn" type="button" class="btn btn-primary">저장</button>
                </div>
            </div>
        </div>
    </div>
    <div class="container">
        <h1>봄장어 팀의 잇츠미 프로젝트</h1>
        <div id="wrapper" class="team-members container">
        </div>
    </div>
</body>

</html>